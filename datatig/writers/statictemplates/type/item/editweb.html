{% extends "base.html" %}

{% block title %}{{ item_id }}{% endblock %}

{% block breadcrumbs %}
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/">Home</a></li>
        <li class="breadcrumb-item"><a href="/type/{{ type.id }}/">{{ type.id }}</a></li>
        <li class="breadcrumb-item"><a href="/type/{{ type.id }}/item/{{ item_id }}/">{{ item_id }}</a></li>
        <li class="breadcrumb-item active" aria-current="page">Edit in Browser</li>
      </ol>
    </nav>
{% endblock %}

{% block body %}

<h2>Edit {{ item_id }} - {{ type.id }}</h2>

<div id="editor_holder">
</div>

<h3>How To Submit</h3>

<div>
    <textarea id="raw_data_out" readonly="readonly"></textarea>
</div>

<p>
    <a href="#" onclick="copy(); return false;"><button type="button" class="btn btn-primary">Copy Data</button></a>
</p>
{% if site_github_url %}
    <p>Go to the Github page to edit <em>{{  item_data.git_filename }}</em> and copy and paste in the content above.</p>
    <a href="https://github.com/{{ site_github_url }}/edit/{{ site_github_primary_branch }}/{{  item_data.git_filename }}" target="_new"><button type="button" class="btn btn-primary">Edit on GitHub</button></a>
{% else %}
    <p>In the git repository, edit <em>{{  item_data.git_filename }}</em> and copy and paste in the content above.</p>
{% endif %}

{% endblock %}


{% block javascript %}
<script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@2.2.1/dist/jsoneditor.min.js"></script>
<script>

    var data = JSON.parse("{{ item_data_json_string | escapejs }}");
    var schema = JSON.parse("{{ type.json_schema_string | escapejs }}");

    const editor_options = {
        startval: data,
        schema: schema,
        theme:'bootstrap4',
        iconlib: "fontawesome5"
    };

    var editor;

    function update() {
        $('#raw_data_out').val(JSON.stringify(editor.getValue(),null,{{ type.pretty_json_indent }}));
    };

    $( document ).ready(function() {
        var element = document.getElementById('editor_holder');
        editor = new JSONEditor(element, editor_options);
        editor.on('change',update);
        update();

        // https://developer.mozilla.org/en-US/docs/Web/API/WindowEventHandlers/onbeforeunload
        window.addEventListener('beforeunload', function (e) {
          // Cancel the event
          e.preventDefault(); // If you prevent default behavior in Mozilla Firefox prompt will always be shown
          // Chrome requires returnValue to be set
          e.returnValue = '';
        });
    });

    function copy() {
        update();
        document.getElementById('raw_data_out').select();
        copied = document.execCommand('copy');
        // TODO show user feedback if copied worked/failed
    };

</script>
{% endblock %}